# ðŸš€ Lead Generation Automation System â€” Production Architecture

> **Cost Commitment:** $0 development cost Â· $0 production cost Â· 100% open-source & free-tier stack
>
> **Scope:** Backend + Database + Automation Flow only (no frontend)
>
> **Version:** 1.0.0

---

## Table of Contents

1. [System Overview](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#1-system-overview)
2. [High-Level Architecture Diagram](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#2-high-level-architecture-diagram)
3. [Technology Stack (100% Free)](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#3-technology-stack)
4. [Project Structure](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#4-project-structure)
5. [Core Modules](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#5-core-modules)
   * 5.1 [Lead Discovery Engine](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#51-lead-discovery-engine)
   * 5.2 [Lead Qualification Engine](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#52-lead-qualification-engine)
   * 5.3 [AI Personalization Engine](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#53-ai-personalization-engine)
   * 5.4 [Outreach Engine](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#54-outreach-engine)
   * 5.5 [Email Tracking System](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#55-email-tracking-system)
   * 5.6 [Notification System (Telegram + WhatsApp)](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#56-notification-system)
   * 5.7 [Daily Report Engine](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#57-daily-report-engine)
   * 5.8 [Scheduler &amp; Orchestrator](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#58-scheduler--orchestrator)
6. [Database Schema](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#6-database-schema)
7. [Automation Flow (Step-by-Step)](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#7-automation-flow)
8. [API Architecture](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#8-api-architecture)
9. [Environment Configuration](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#9-environment-configuration)
10. [Deployment Guide (Free Hosting)](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#10-deployment-guide)
11. [Rate Limits &amp; Free Tier Boundaries](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#11-rate-limits--free-tier-boundaries)
12. [Implementation Roadmap](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#12-implementation-roadmap)
13. [Security Checklist](https://claude.ai/chat/cc93f3d6-a214-4c84-8561-11f6ed353817#13-security-checklist)

---

## 1. System Overview

This system is a fully automated, zero-cost lead generation and outreach pipeline. It runs daily to:

* Discover local businesses (stores, shops, brands) via Google Places API that lack a web presence
* Qualify leads by checking if they have an existing website or digital platform
* Generate hyper-personalized outreach emails using a free AI model (Groq LLaMA)
* Send emails with professional PDF attachments (case studies, proposals)
* Track email opens, clicks, and replies
* Push real-time alerts to Telegram and WhatsApp for hot leads
* Generate a daily summary email with an Excel report showing engagement metrics

---

## 2. High-Level Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DAILY CRON TRIGGER (00:00)                        â”‚
â”‚                         APScheduler / Celery Beat                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   LEAD DISCOVERY ENGINE  â”‚
                    â”‚  Google Places API       â”‚
                    â”‚  + httpx scraper         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚  Raw leads
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  LEAD QUALIFICATION      â”‚
                    â”‚  Website check (httpx)   â”‚
                    â”‚  Domain WHOIS lookup     â”‚
                    â”‚  Social media check      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚  Qualified leads (no/weak web presence)
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  AI PERSONALIZATION      â”‚
                    â”‚  Groq API (LLaMA 3.1)    â”‚
                    â”‚  Custom email + subject  â”‚
                    â”‚  PDF attachment gen      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚  Personalized email payload
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚              OUTREACH ENGINE                  â”‚
          â”‚    Brevo SMTP (300 emails/day free)           â”‚
          â”‚    Embedded tracking pixel                    â”‚
          â”‚    Click-tracked links via redirect API       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                       â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  EMAIL TRACKING   â”‚    â”‚  NOTIFICATION ENGINE  â”‚
      â”‚  Pixel open track â”‚    â”‚  Telegram Bot API     â”‚
      â”‚  Link click track â”‚    â”‚  WhatsApp CallMeBot   â”‚
      â”‚  Reply detection  â”‚    â”‚  Real-time hot leads  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚    SUPABASE POSTGRESQL    â”‚
      â”‚    All leads + events     â”‚
      â”‚    Click/open analytics   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚    DAILY REPORT ENGINE    â”‚
      â”‚    openpyxl Excel gen     â”‚
      â”‚    Summary email via SMTP â”‚
      â”‚    Sent to admin email    â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Technology Stack

### Runtime & Language

| Layer          | Technology                | Why                                  | Cost |
| -------------- | ------------------------- | ------------------------------------ | ---- |
| Language       | **Python 3.12**     | Ecosystem for automation, AI, data   | Free |
| Framework      | **FastAPI**         | Async, fast, auto OpenAPI docs       | Free |
| Task Queue     | **Celery 5.x**      | Distributed async tasks              | Free |
| Message Broker | **Redis (Upstash)** | Celery broker, 10k req/day free      | Free |
| Scheduler      | **APScheduler**     | Cron-based job scheduling in-process | Free |

### Database

| Layer      | Technology                         | Free Tier                     |
| ---------- | ---------------------------------- | ----------------------------- |
| Primary DB | **Supabase (PostgreSQL 15)** | 500MB DB, 2GB bandwidth/month |
| ORM        | **SQLAlchemy 2.x + asyncpg** | Free                          |
| Migrations | **Alembic**                  | Free                          |
| Caching    | **Upstash Redis**            | 10,000 commands/day           |

### Lead Discovery

| Layer              | Technology                        | Free Tier                                |
| ------------------ | --------------------------------- | ---------------------------------------- |
| Places Search      | **Google Places API (New)** | $200/month credit (~2,800 searches free) |
| Web Scraping       | **httpx + BeautifulSoup4**  | Free                                     |
| Browser Automation | **Playwright (headless)**   | Free                                     |
| Domain Check       | **python-whois**            | Free                                     |
| DNS Lookup         | **dnspython**               | Free                                     |

### AI / Personalization

| Layer          | Technology                        | Free Tier           |
| -------------- | --------------------------------- | ------------------- |
| LLM            | **Groq API (LLaMA 3.1 8B)** | 14,400 req/day free |
| Embeddings     | **sentence-transformers**   | Local, fully free   |
| PDF Generation | **ReportLab + WeasyPrint**  | Free                |

### Email

| Layer           | Technology                            | Free Tier                          |
| --------------- | ------------------------------------- | ---------------------------------- |
| Email Provider  | **Brevo (formerly Sendinblue)** | 300 emails/day, unlimited contacts |
| SMTP Client     | **aiosmtplib**                  | Free                               |
| Template Engine | **Jinja2**                      | Free                               |
| Reply Tracking  | **IMAP polling (imaplib)**      | Free                               |

### Notifications

| Layer    | Technology                    | Free Tier          |
| -------- | ----------------------------- | ------------------ |
| Telegram | **python-telegram-bot** | 100% free, Bot API |
| WhatsApp | **CallMeBot API**       | Free personal use  |

### Reporting

| Layer  | Technology           | Free Tier |
| ------ | -------------------- | --------- |
| Excel  | **openpyxl**   | Free      |
| Charts | **matplotlib** | Free      |

### Infrastructure

| Layer      | Technology                            | Free Tier                                      |
| ---------- | ------------------------------------- | ---------------------------------------------- |
| Hosting    | **Render.com**                  | Free tier: 1 web service + 1 background worker |
| Container  | **Docker + Docker Compose**     | Free                                           |
| CI/CD      | **GitHub Actions**              | 2,000 min/month free                           |
| Secrets    | **GitHub Secrets + Render Env** | Free                                           |
| Logging    | **Loguru + Render logs**        | Free                                           |
| Monitoring | **Uptime Robot**                | 50 monitors free                               |

---

## 4. Project Structure

```
lead-gen-automation/
â”‚
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                     # FastAPI app entry point
â”‚   â”œâ”€â”€ config.py                   # Settings via pydantic-settings
â”‚   â”‚
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ database.py             # SQLAlchemy async engine
â”‚   â”‚   â”œâ”€â”€ redis_client.py         # Upstash Redis connection
â”‚   â”‚   â”œâ”€â”€ scheduler.py            # APScheduler setup
â”‚   â”‚   â””â”€â”€ logging.py              # Loguru config
â”‚   â”‚
â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â”œâ”€â”€ discovery/
â”‚   â”‚   â”‚   â”œâ”€â”€ google_places.py    # Places API client
â”‚   â”‚   â”‚   â”œâ”€â”€ scraper.py          # httpx/Playwright scraper
â”‚   â”‚   â”‚   â””â”€â”€ deduplication.py    # Prevent re-processing
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ qualification/
â”‚   â”‚   â”‚   â”œâ”€â”€ website_checker.py  # DNS + HTTP checks
â”‚   â”‚   â”‚   â”œâ”€â”€ social_checker.py   # Instagram/FB presence check
â”‚   â”‚   â”‚   â””â”€â”€ scorer.py           # Lead quality scoring
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ personalization/
â”‚   â”‚   â”‚   â”œâ”€â”€ groq_client.py      # Groq LLaMA API
â”‚   â”‚   â”‚   â”œâ”€â”€ email_generator.py  # AI email composition
â”‚   â”‚   â”‚   â”œâ”€â”€ pdf_generator.py    # ReportLab proposal PDF
â”‚   â”‚   â”‚   â””â”€â”€ templates/
â”‚   â”‚   â”‚       â”œâ”€â”€ email_html.j2   # Jinja2 HTML email template
â”‚   â”‚   â”‚       â””â”€â”€ proposal.j2     # Proposal template
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ outreach/
â”‚   â”‚   â”‚   â”œâ”€â”€ email_sender.py     # Brevo SMTP sender
â”‚   â”‚   â”‚   â”œâ”€â”€ attachment_builder.py
â”‚   â”‚   â”‚   â””â”€â”€ scheduler.py        # Outreach queue
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ tracking/
â”‚   â”‚   â”‚   â”œâ”€â”€ pixel_tracker.py    # Open tracking endpoint
â”‚   â”‚   â”‚   â”œâ”€â”€ click_tracker.py    # Click redirect endpoint
â”‚   â”‚   â”‚   â”œâ”€â”€ reply_tracker.py    # IMAP reply poller
â”‚   â”‚   â”‚   â””â”€â”€ event_logger.py     # Write events to DB
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ notifications/
â”‚   â”‚   â”‚   â”œâ”€â”€ telegram_bot.py     # Telegram Bot alerts
â”‚   â”‚   â”‚   â””â”€â”€ whatsapp_bot.py     # CallMeBot WhatsApp
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ reporting/
â”‚   â”‚       â”œâ”€â”€ excel_builder.py    # openpyxl report
â”‚   â”‚       â”œâ”€â”€ email_reporter.py   # Daily summary email
â”‚   â”‚       â””â”€â”€ analytics.py        # Stats aggregation
â”‚   â”‚
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ lead.py                 # Lead SQLAlchemy model
â”‚   â”‚   â”œâ”€â”€ campaign.py             # Campaign model
â”‚   â”‚   â”œâ”€â”€ email_event.py          # Open/click/reply events
â”‚   â”‚   â””â”€â”€ daily_report.py        # Report log model
â”‚   â”‚
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ lead.py                 # Pydantic schemas
â”‚   â”‚   â”œâ”€â”€ campaign.py
â”‚   â”‚   â””â”€â”€ report.py
â”‚   â”‚
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ v1/
â”‚   â”‚   â”‚   â”œâ”€â”€ tracking.py         # /track/open, /track/click
â”‚   â”‚   â”‚   â”œâ”€â”€ webhooks.py         # Brevo delivery webhooks
â”‚   â”‚   â”‚   â””â”€â”€ health.py           # Health check
â”‚   â”‚   â””â”€â”€ router.py
â”‚   â”‚
â”‚   â””â”€â”€ tasks/
â”‚       â”œâ”€â”€ celery_app.py           # Celery instance
â”‚       â”œâ”€â”€ daily_pipeline.py       # Master daily task
â”‚       â”œâ”€â”€ discovery_tasks.py
â”‚       â”œâ”€â”€ outreach_tasks.py
â”‚       â””â”€â”€ report_tasks.py
â”‚
â”œâ”€â”€ migrations/                     # Alembic migrations
â”‚   â”œâ”€â”€ env.py
â”‚   â””â”€â”€ versions/
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_discovery.py
â”‚   â”œâ”€â”€ test_qualification.py
â”‚   â””â”€â”€ test_outreach.py
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ seed_targets.py             # Seed target locations
â”‚   â””â”€â”€ manual_trigger.py          # Manual pipeline run
â”‚
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ .env.example
â”œâ”€â”€ alembic.ini
â””â”€â”€ README.md
```

---

## 5. Core Modules

### 5.1 Lead Discovery Engine

**File:** `app/modules/discovery/google_places.py`

**Purpose:** Daily scan of target locations to find stores, shops, or brands that need a digital presence.

**Process:**

1. Read target locations from `target_locations` DB table (city names, coordinates, categories)
2. Call Google Places **Text Search** and **Nearby Search** API for each location-category pair
3. For each result, extract: `place_id`, `name`, `address`, `phone`, `website`, `rating`, `types`, `business_status`
4. Pass results to deduplication layer (check against `leads` table by `place_id`)
5. Store new unique leads with `status = "discovered"`

**Key Implementation Notes:**

* Use `place_id` as unique identifier â€” never re-process the same place
* Categories to search: `restaurant`, `store`, `clothing_store`, `food`, `bakery`, `florist`, `beauty_salon`, `gym`, `electronics_store`, `home_goods_store`, `jewelry_store`, `pet_store`, `shoe_store`
* Rotate API calls to stay within the $200/month free credit (~2,800 searches/day if used wisely)
* Use `fields` mask to only request needed fields (reduces API cost)

```python
# google_places.py - Core search call
async def search_places(location: str, category: str, radius: int = 5000):
    params = {
        "textQuery": f"{category} in {location}",
        "fields": "places.id,places.displayName,places.formattedAddress,places.nationalPhoneNumber,places.websiteUri,places.rating,places.businessStatus,places.googleMapsUri",
        "maxResultCount": 20,
    }
    # POST to https://places.googleapis.com/v1/places:searchText
    # Header: X-Goog-FieldMask, X-Goog-Api-Key
```

---

### 5.2 Lead Qualification Engine

**File:** `app/modules/qualification/`

**Purpose:** Filter discovered leads to only those who need a website/platform.

**Qualification Criteria (scored 0-100):**

| Check                                  | Score Impact | Method            |
| -------------------------------------- | ------------ | ----------------- |
| No website in Google Places data       | +40          | Field check       |
| Domain does not resolve (DNS NXDOMAIN) | +30          | `dnspython`     |
| Website returns 4xx/5xx                | +25          | `httpx`GET      |
| No website meta tags found             | +15          | `BeautifulSoup` |
| No Instagram/Facebook business page    | +10          | URL pattern check |
| Rating >= 4.0 (engaged business)       | +10          | Field check       |
| Phone number present (reachable)       | +5           | Field check       |

**Threshold:** Leads scoring **â‰¥ 50** are marked `status = "qualified"` and forwarded to the personalization engine.

```python
# scorer.py
async def qualify_lead(lead: Lead) -> tuple[bool, int]:
    score = 0
    if not lead.website_url:
        score += 40
    if not await dns_resolves(lead.domain):
        score += 30
    elif not await website_responds(lead.website_url):
        score += 25
    # ... additional checks
    return score >= 50, score
```

---

### 5.3 AI Personalization Engine

**File:** `app/modules/personalization/`

**Purpose:** Generate hyper-personalized outreach emails and PDF proposals using free AI.

**AI Provider:** Groq API (LLaMA 3.1 8B) â€” 14,400 free requests/day

**What the AI generates:**

1. A personalized subject line mentioning the business name and a relevant hook
2. Email body (HTML) referencing their specific business type, location, and potential benefits
3. 3 concrete benefit bullet points tailored to their industry
4. A custom call-to-action

**PDF Attachment (generated per lead):**

* Page 1: "Why [Business Name] Needs a Digital Platform" â€” AI-written intro
* Page 2: Industry case study (pre-written, loaded from template)
* Page 3: Your service packages + pricing overview
* Page 4: Contact information + QR code link

**Prompt Engineering:**

```python
PERSONALIZATION_PROMPT = """
You are a professional business development writer. Write a short, warm outreach email for:

Business: {business_name}
Category: {business_type}
Location: {location}
Rating: {rating} stars on Google ({review_count} reviews)
Current web presence: {web_presence_status}

Requirements:
- Subject line: Compelling, mentions business name, max 60 chars
- Email body: 3 short paragraphs, conversational but professional
- Paragraph 1: Acknowledge their business specifically
- Paragraph 2: Explain what a custom platform/website could do for their specific business type
- Paragraph 3: Soft CTA - ask if they'd like a free consultation
- Include 3 specific ROI benefits for a {business_type}
- Tone: Helpful partner, not salesy
- Length: 150-200 words max

Return JSON: {{"subject": "...", "body_html": "...", "benefits": ["...", "...", "..."]}}
"""
```

---

### 5.4 Outreach Engine

**File:** `app/modules/outreach/email_sender.py`

**Provider:** Brevo (Sendinblue) SMTP â€” 300 emails/day free

**Email Structure:**

```
From: Your Name <yourname@yourdomain.com>
To: {lead_email}
Subject: {AI-generated subject}
Reply-To: {your_reply_email}

Body: 
  - HTML email from Jinja2 template
  - Tracking pixel: <img src="https://yourapp.render.com/track/open/{token}" />
  - All links wrapped: https://yourapp.render.com/track/click/{token}?url={encoded_url}

Attachments:
  - {BusinessName}_Proposal.pdf (generated by ReportLab)
  - Optional: Platform_Showcase.pdf (static brochure)
```

**Email extraction strategy (since Google Places may not provide email):**

1. Check Places API `websiteUri` â€” scrape contact page for email
2. Common patterns: `info@domain.com`, `hello@domain.com`, `contact@domain.com`
3. Check Google Business page for listed email
4. If no email found: mark lead as `status = "no_email_found"` and skip

**Rate Limiting:**

* Max 10 emails/hour to avoid spam flags
* Minimum 2-minute gap between emails to same domain
* Celery task with `countdown` delay between sends

---

### 5.5 Email Tracking System

**File:** `app/modules/tracking/`

**Three tracking mechanisms:**

#### A. Open Tracking (Pixel)

```
GET /track/open/{tracking_token}
â†’ Returns 1x1 transparent GIF
â†’ Logs email_event(type="open", lead_id, timestamp, ip, user_agent)
â†’ Updates lead.status = "opened" if first open
â†’ Triggers Telegram alert if first open
```

#### B. Click Tracking (Redirect)

```
GET /track/click/{tracking_token}?url={encoded_destination}
â†’ Logs email_event(type="click", lead_id, timestamp, url_clicked)
â†’ Updates lead.status = "clicked"
â†’ Triggers "HOT LEAD" Telegram + WhatsApp alert
â†’ 302 Redirect to destination URL
```

#### C. Reply Tracking (IMAP Poll)

```python
# Runs every 30 minutes via Celery periodic task
async def poll_replies():
    # Connect to reply-to mailbox via IMAP
    # Search for emails in INBOX from last 30 minutes
    # Match sender email against leads table
    # If match found: update lead.status = "replied"
    # Trigger URGENT Telegram + WhatsApp notification
```

**Tracking Token Design:**

* Format: `{lead_id}_{campaign_id}_{timestamp_hash}` â€” URL-safe base64
* Stored in `email_events.tracking_token` column with index
* No PII in token â€” only internal IDs

---

### 5.6 Notification System

**File:** `app/modules/notifications/`

#### Telegram Bot

```python
# telegram_bot.py
# Events that trigger Telegram alerts:

OPEN_ALERT = """
ðŸ‘ Email Opened!
Business: {business_name}
Location: {location}
Category: {business_type}
Time: {timestamp}
Lead Score: {score}/100
"""

CLICK_ALERT = """
ðŸ”¥ HOT LEAD - Link Clicked!
Business: {business_name}
Phone: {phone}
Clicked: {url_clicked}
Time: {timestamp}
â†’ Follow up NOW recommended
"""

REPLY_ALERT = """
ðŸš¨ REPLY RECEIVED!
Business: {business_name}
Their Email: {sender_email}
Time: {timestamp}
â†’ Check your inbox immediately
"""
```

**Setup:** Create bot via @BotFather â†’ get `BOT_TOKEN` â†’ get your `CHAT_ID` via `/getUpdates`

#### WhatsApp (CallMeBot)

```python
# whatsapp_bot.py
# CallMeBot: Free personal WhatsApp alerts
# Setup: Send "I allow callmebot to send me messages" to +34 644 89 26 06
# Get your API key

async def send_whatsapp_alert(message: str):
    url = "https://api.callmebot.com/whatsapp.php"
    params = {
        "phone": settings.WHATSAPP_NUMBER,   # +91XXXXXXXXXX format
        "text": message,
        "apikey": settings.CALLMEBOT_API_KEY
    }
    async with httpx.AsyncClient() as client:
        await client.get(url, params=params)
```

**Alert Strategy:**

* Telegram: All events (open, click, reply, daily summary stats)
* WhatsApp: Only hot events (click + reply) to avoid notification fatigue

---

### 5.7 Daily Report Engine

**File:** `app/modules/reporting/`

**Runs at:** 23:30 daily (30 min before midnight)

**Excel Report Structure (openpyxl):**

**Sheet 1: Daily Summary**

| Metric                 | Value   |
| ---------------------- | ------- |
| Total leads discovered | 45      |
| Qualified leads        | 12      |
| Emails sent            | 12      |
| Emails opened          | 7 (58%) |
| Links clicked          | 3 (25%) |
| Replies received       | 1 (8%)  |
| Ready to build         | 1       |

**Sheet 2: Lead Details**

| Business      | Category | Location | Email Sent | Opened   | Clicked  | Replied | Status   | Phone  | Google Maps |
| ------------- | -------- | -------- | ---------- | -------- | -------- | ------- | -------- | ------ | ----------- |
| Sharma Bakery | Bakery   | Kolkata  | âœ“ 10:30   | âœ“ 14:22 | âœ“ 14:25 | âœ—      | HOT LEAD | +91... | Link        |
| ...           |          |          |            |          |          |         |          |        |             |

**Sheet 3: Weekly Trend** (last 7 days chart data)

**Email report sent to admin:**

* Subject: `[LeadGen] Daily Report - {date} | {emails_sent} sent | {clicks} clicks | {replies} replies`
* Body: Summary HTML with key metrics
* Attachment: `LeadGen_Report_{YYYY-MM-DD}.xlsx`

---

### 5.8 Scheduler & Orchestrator

**File:** `app/tasks/daily_pipeline.py`

**Cron Schedule:**

```python
# APScheduler jobs
scheduler.add_job(run_discovery,        "cron", hour=6,  minute=0)   # 6:00 AM
scheduler.add_job(run_qualification,    "cron", hour=7,  minute=0)   # 7:00 AM
scheduler.add_job(run_personalization,  "cron", hour=8,  minute=0)   # 8:00 AM
scheduler.add_job(run_outreach,         "cron", hour=9,  minute=0)   # 9:00 AM (business hours)
scheduler.add_job(poll_replies,         "interval", minutes=30)       # Every 30 min
scheduler.add_job(generate_daily_report,"cron", hour=23, minute=30)  # 11:30 PM
```

**Master Pipeline Task:**

```python
@celery_app.task(name="daily_pipeline")
async def run_daily_pipeline():
    logger.info("Starting daily lead generation pipeline")
  
    # Step 1: Discovery
    raw_leads = await run_discovery_for_all_targets()
    await notify_telegram(f"ðŸ” Discovery complete: {len(raw_leads)} raw leads found")
  
    # Step 2: Qualification
    qualified = await qualify_all_leads(raw_leads)
    await notify_telegram(f"âœ… Qualified: {len(qualified)} leads (need digital platform)")
  
    # Step 3: Personalization
    emails = await personalize_all_leads(qualified)
    await notify_telegram(f"ðŸ¤– AI personalization: {len(emails)} emails ready")
  
    # Step 4: Outreach (rate-limited)
    sent = await send_outreach_emails(emails)
    await notify_telegram(f"ðŸ“§ Outreach complete: {sent} emails sent")
  
    logger.info("Daily pipeline complete")
```

---

## 6. Database Schema

**Provider:** Supabase (PostgreSQL 15) â€” Free tier

```sql
-- ============================================================
-- TARGET LOCATIONS (input config)
-- ============================================================
CREATE TABLE target_locations (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    city            VARCHAR(100) NOT NULL,
    state           VARCHAR(100),
    country         VARCHAR(100) DEFAULT 'India',
    lat             DECIMAL(10, 8),
    lng             DECIMAL(11, 8),
    categories      TEXT[],                    -- ['bakery', 'clothing_store', ...]
    radius_meters   INTEGER DEFAULT 5000,
    is_active       BOOLEAN DEFAULT TRUE,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================================
-- LEADS (core entity)
-- ============================================================
CREATE TABLE leads (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    place_id            VARCHAR(255) UNIQUE NOT NULL,   -- Google Places ID
    business_name       VARCHAR(255) NOT NULL,
    category            VARCHAR(100),
    address             TEXT,
    city                VARCHAR(100),
    phone               VARCHAR(50),
    email               VARCHAR(255),
    website_url         TEXT,
    google_maps_url     TEXT,
    rating              DECIMAL(3,1),
    review_count        INTEGER,
  
    -- Qualification
    qualification_score INTEGER DEFAULT 0,
    has_website         BOOLEAN DEFAULT FALSE,
    has_social_media    BOOLEAN DEFAULT FALSE,
    web_presence_notes  TEXT,
  
    -- Status lifecycle
    status              VARCHAR(50) DEFAULT 'discovered',
    -- Values: discovered â†’ qualified â†’ email_sent â†’ opened â†’ clicked â†’ replied â†’ converted | disqualified | bounced
  
    -- Timestamps
    discovered_at       TIMESTAMPTZ DEFAULT NOW(),
    qualified_at        TIMESTAMPTZ,
    email_sent_at       TIMESTAMPTZ,
    first_opened_at     TIMESTAMPTZ,
    first_clicked_at    TIMESTAMPTZ,
    first_replied_at    TIMESTAMPTZ,
  
    -- Metadata
    raw_places_data     JSONB,
    notes               TEXT,
    created_at          TIMESTAMPTZ DEFAULT NOW(),
    updated_at          TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_leads_status ON leads(status);
CREATE INDEX idx_leads_place_id ON leads(place_id);
CREATE INDEX idx_leads_discovered_at ON leads(discovered_at);

-- ============================================================
-- CAMPAIGNS (email batches)
-- ============================================================
CREATE TABLE campaigns (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name            VARCHAR(255) NOT NULL,
    campaign_date   DATE NOT NULL,
    status          VARCHAR(50) DEFAULT 'pending',
    -- Values: pending â†’ running â†’ completed â†’ failed
  
    total_leads     INTEGER DEFAULT 0,
    emails_sent     INTEGER DEFAULT 0,
    emails_opened   INTEGER DEFAULT 0,
    links_clicked   INTEGER DEFAULT 0,
    replies_received INTEGER DEFAULT 0,
  
    started_at      TIMESTAMPTZ,
    completed_at    TIMESTAMPTZ,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================================
-- EMAIL OUTREACH (individual sends)
-- ============================================================
CREATE TABLE email_outreach (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lead_id             UUID REFERENCES leads(id) ON DELETE CASCADE,
    campaign_id         UUID REFERENCES campaigns(id),
  
    to_email            VARCHAR(255) NOT NULL,
    subject             TEXT NOT NULL,
    body_html           TEXT,
    tracking_token      VARCHAR(255) UNIQUE NOT NULL,
  
    ai_generated        BOOLEAN DEFAULT TRUE,
    has_attachment      BOOLEAN DEFAULT FALSE,
    attachment_names    TEXT[],
  
    status              VARCHAR(50) DEFAULT 'queued',
    -- Values: queued â†’ sent â†’ delivered â†’ bounced â†’ failed
  
    sent_at             TIMESTAMPTZ,
    delivered_at        TIMESTAMPTZ,
    bounce_reason       TEXT,
  
    brevo_message_id    VARCHAR(255),
    created_at          TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_outreach_lead_id ON email_outreach(lead_id);
CREATE INDEX idx_outreach_tracking_token ON email_outreach(tracking_token);

-- ============================================================
-- EMAIL EVENTS (open/click/reply tracking)
-- ============================================================
CREATE TABLE email_events (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lead_id         UUID REFERENCES leads(id),
    outreach_id     UUID REFERENCES email_outreach(id),
    tracking_token  VARCHAR(255),
  
    event_type      VARCHAR(50) NOT NULL,
    -- Values: open | click | reply | bounce | unsubscribe
  
    url_clicked     TEXT,
    ip_address      INET,
    user_agent      TEXT,
  
    occurred_at     TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_events_lead_id ON email_events(lead_id);
CREATE INDEX idx_events_type ON email_events(event_type);
CREATE INDEX idx_events_occurred_at ON email_events(occurred_at);

-- ============================================================
-- DAILY REPORTS (audit log)
-- ============================================================
CREATE TABLE daily_reports (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    report_date         DATE UNIQUE NOT NULL,
  
    leads_discovered    INTEGER DEFAULT 0,
    leads_qualified     INTEGER DEFAULT 0,
    emails_sent         INTEGER DEFAULT 0,
    emails_opened       INTEGER DEFAULT 0,
    links_clicked       INTEGER DEFAULT 0,
    replies_received    INTEGER DEFAULT 0,
    new_conversions     INTEGER DEFAULT 0,
  
    report_file_path    TEXT,
    email_sent_to       VARCHAR(255),
  
    pipeline_started_at TIMESTAMPTZ,
    pipeline_ended_at   TIMESTAMPTZ,
    pipeline_status     VARCHAR(50) DEFAULT 'pending',
    error_log           TEXT,
  
    created_at          TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================================
-- AUTO-UPDATE updated_at trigger
-- ============================================================
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN NEW.updated_at = NOW(); RETURN NEW; END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_leads_updated_at
BEFORE UPDATE ON leads
FOR EACH ROW EXECUTE FUNCTION update_updated_at();
```

---

## 7. Automation Flow

```
DAY STARTS @ 6:00 AM
â”‚
â”œâ”€ [STEP 1] DISCOVERY (6:00 AM)
â”‚   â”œâ”€ Read all active target_locations from DB
â”‚   â”œâ”€ For each location Ã— category pair:
â”‚   â”‚   â”œâ”€ Call Google Places Text Search API
â”‚   â”‚   â”œâ”€ Extract place_id, name, address, phone, website, rating
â”‚   â”‚   â”œâ”€ Check if place_id exists in leads table
â”‚   â”‚   â””â”€ If new: INSERT with status="discovered"
â”‚   â””â”€ Telegram: "ðŸ” Discovery: X new leads found in Y locations"
â”‚
â”œâ”€ [STEP 2] QUALIFICATION (7:00 AM)
â”‚   â”œâ”€ Fetch all leads with status="discovered" AND discovered_at=today
â”‚   â”œâ”€ For each lead:
â”‚   â”‚   â”œâ”€ Run website_checker (DNS + HTTP response)
â”‚   â”‚   â”œâ”€ Run social_checker (pattern match Instagram/FB)
â”‚   â”‚   â”œâ”€ Calculate qualification_score (0-100)
â”‚   â”‚   â”œâ”€ If score >= 50: UPDATE status="qualified"
â”‚   â”‚   â””â”€ Else: UPDATE status="disqualified"
â”‚   â””â”€ Telegram: "âœ… Qualified: X/Y leads need digital platform"
â”‚
â”œâ”€ [STEP 3] EMAIL EXTRACTION (7:30 AM)
â”‚   â”œâ”€ For qualified leads without email:
â”‚   â”‚   â”œâ”€ Fetch website contact page (if website exists partially)
â”‚   â”‚   â”œâ”€ Try common email patterns (info@, contact@, hello@)
â”‚   â”‚   â”œâ”€ Check Google Places contact fields
â”‚   â”‚   â””â”€ If email found: UPDATE leads.email
â”‚   â””â”€ Leads without email: mark status="no_email" (will skip outreach)
â”‚
â”œâ”€ [STEP 4] PERSONALIZATION (8:00 AM)
â”‚   â”œâ”€ For each qualified lead WITH email:
â”‚   â”‚   â”œâ”€ Build Groq prompt with business details
â”‚   â”‚   â”œâ”€ Call Groq LLaMA 3.1 8B API
â”‚   â”‚   â”œâ”€ Parse JSON response (subject, body_html, benefits)
â”‚   â”‚   â”œâ”€ Generate PDF proposal (ReportLab)
â”‚   â”‚   â”œâ”€ Generate tracking_token for this lead+campaign
â”‚   â”‚   â”œâ”€ Inject tracking pixel into email body
â”‚   â”‚   â”œâ”€ Wrap all URLs with /track/click/ redirect
â”‚   â”‚   â””â”€ INSERT email_outreach record with status="queued"
â”‚   â””â”€ Telegram: "ðŸ¤– AI: X personalized emails ready to send"
â”‚
â”œâ”€ [STEP 5] OUTREACH (9:00 AM - 5:00 PM, rate-limited)
â”‚   â”œâ”€ Fetch all email_outreach records with status="queued"
â”‚   â”œâ”€ For each email (rate: 1 email per 5-10 minutes max):
â”‚   â”‚   â”œâ”€ Build final HTML with Jinja2 template
â”‚   â”‚   â”œâ”€ Attach PDF proposal
â”‚   â”‚   â”œâ”€ Send via Brevo SMTP (aiosmtplib)
â”‚   â”‚   â”œâ”€ UPDATE email_outreach.status="sent"
â”‚   â”‚   â”œâ”€ UPDATE leads.status="email_sent"
â”‚   â”‚   â””â”€ Log leads.email_sent_at=NOW()
â”‚   â””â”€ Telegram: "ðŸ“§ Outreach: X emails sent successfully"
â”‚
â”œâ”€ [CONTINUOUS - Every 30 min] REPLY POLLING
â”‚   â”œâ”€ Connect to reply-to inbox via IMAP
â”‚   â”œâ”€ Fetch emails from last 30 minutes
â”‚   â”œâ”€ For each email: match sender to leads.email
â”‚   â”œâ”€ If match: UPDATE leads.status="replied"
â”‚   â”œâ”€ INSERT email_event(type="reply")
â”‚   â””â”€ ALERT: Telegram + WhatsApp urgent notification
â”‚
â”œâ”€ [CONTINUOUS - Real-time] OPEN/CLICK TRACKING
â”‚   â”œâ”€ /track/open/{token}: Log open, update lead status, Telegram alert
â”‚   â””â”€ /track/click/{token}: Log click, update lead status, HOT LEAD alerts
â”‚
â””â”€ [STEP 6] DAILY REPORT (11:30 PM)
    â”œâ”€ Aggregate today's statistics from all tables
    â”œâ”€ Identify leads by status (opened, clicked, replied, converted)
    â”œâ”€ Build Excel report (3 sheets: summary, lead details, trend)
    â”œâ”€ Generate summary HTML email
    â”œâ”€ Send email with Excel attachment to admin
    â”œâ”€ INSERT daily_reports record
    â””â”€ Telegram: "ðŸ“Š Daily report sent! Summary: X sent | Y clicked | Z replied"
```

---

## 8. API Architecture

**Base URL:** `https://your-app.onrender.com/api/v1`

### Tracking Endpoints (Public â€” no auth)

```
GET  /track/open/{token}
     â†’ Returns 1x1 GIF, logs open event

GET  /track/click/{token}?url={encoded_url}
     â†’ Logs click event, redirects to destination
```

### Webhook Endpoints

```
POST /webhooks/brevo
     â†’ Receives Brevo delivery/bounce webhooks
     â†’ Updates email_outreach.status accordingly
     â†’ Header: X-Mailin-Custom (shared secret validation)
```

### Internal Management Endpoints (Protected with API Key)

```
GET  /health
     â†’ System health check (DB, Redis, external APIs)

POST /pipeline/trigger
     â†’ Manually trigger full pipeline
     â†’ Body: {"date": "2025-01-01", "dry_run": false}

GET  /leads?status=qualified&date=today&page=1&limit=50
     â†’ List leads with filters

GET  /leads/{lead_id}
     â†’ Lead detail with all events

GET  /campaigns?date=today
     â†’ Campaign stats

POST /locations
     â†’ Add new target location
     â†’ Body: {"city": "Kolkata", "categories": ["bakery", "store"]}

GET  /reports/{date}
     â†’ Download daily report
```

**Authentication:** Simple API key in `X-API-Key` header (stored in env var)

---

## 9. Environment Configuration

**File:** `.env.example`

```bash
# ============================================================
# APPLICATION
# ============================================================
APP_ENV=production
APP_SECRET_KEY=your-super-secret-key-here
API_KEY=your-admin-api-key-here
APP_URL=https://your-app.onrender.com

# ============================================================
# DATABASE (Supabase)
# ============================================================
DATABASE_URL=postgresql+asyncpg://postgres:[password]@db.[ref].supabase.co:5432/postgres
SUPABASE_URL=https://[ref].supabase.co
SUPABASE_ANON_KEY=your-anon-key

# ============================================================
# REDIS (Upstash)
# ============================================================
REDIS_URL=rediss://:[password]@[endpoint].upstash.io:6380

# ============================================================
# GOOGLE PLACES API
# ============================================================
GOOGLE_PLACES_API_KEY=AIza...

# ============================================================
# GROQ API (Free LLM)
# ============================================================
GROQ_API_KEY=gsk_...
GROQ_MODEL=llama-3.1-8b-instant

# ============================================================
# EMAIL â€” BREVO SMTP (300/day free)
# ============================================================
BREVO_SMTP_HOST=smtp-relay.brevo.com
BREVO_SMTP_PORT=587
BREVO_SMTP_USER=your@email.com
BREVO_SMTP_PASSWORD=your-brevo-smtp-key
FROM_EMAIL=yourname@yourdomain.com
FROM_NAME=Your Name
REPLY_TO_EMAIL=replies@yourdomain.com

# Email tracking (IMAP for reply detection)
IMAP_HOST=imap.gmail.com
IMAP_USER=replies@yourdomain.com
IMAP_PASSWORD=your-app-password

# Admin email for daily reports
ADMIN_EMAIL=you@youremail.com

# ============================================================
# TELEGRAM BOT
# ============================================================
TELEGRAM_BOT_TOKEN=123456:ABC...
TELEGRAM_CHAT_ID=123456789

# ============================================================
# WHATSAPP (CallMeBot â€” Free)
# ============================================================
WHATSAPP_NUMBER=+91XXXXXXXXXX
CALLMEBOT_API_KEY=your-callmebot-key

# ============================================================
# SCHEDULER TIMES (24hr format)
# ============================================================
DISCOVERY_HOUR=6
QUALIFICATION_HOUR=7
PERSONALIZATION_HOUR=8
OUTREACH_HOUR=9
REPORT_HOUR=23
REPORT_MINUTE=30
EMAIL_SEND_INTERVAL_SECONDS=360   # 1 email per 6 minutes
```

---

## 10. Deployment Guide

### Local Development

```bash
# Clone & setup
git clone https://github.com/yourname/lead-gen-automation.git
cd lead-gen-automation

# Create virtualenv
python -m venv venv
source venv/bin/activate

# Install dependencies
pip install -r requirements.txt

# Install Playwright browsers (for scraping)
playwright install chromium

# Copy env
cp .env.example .env
# Fill in your API keys

# Run DB migrations
alembic upgrade head

# Seed target locations
python scripts/seed_targets.py

# Start all services
docker-compose up -d
```

### Docker Compose (Local)

```yaml
# docker-compose.yml
version: '3.9'

services:
  api:
    build: .
    ports:
      - "8000:8000"
    env_file: .env
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    depends_on:
      - redis

  worker:
    build: .
    env_file: .env
    command: celery -A app.tasks.celery_app worker --loglevel=info --concurrency=2
    depends_on:
      - redis

  beat:
    build: .
    env_file: .env
    command: celery -A app.tasks.celery_app beat --loglevel=info
    depends_on:
      - redis

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
```

### Production Deployment on Render.com (Free)

**Step 1: Create Render account at render.com**

**Step 2: Create Web Service**

```
Name: lead-gen-api
Environment: Docker
Branch: main
```

**Step 3: Create Background Worker**

```
Name: lead-gen-worker
Environment: Docker
Build Command: pip install -r requirements.txt
Start Command: celery -A app.tasks.celery_app worker --loglevel=info
```

**Step 4: Set all environment variables in Render dashboard**

**Step 5: Configure Render health check**

```
Health Check Path: /api/v1/health
```

**Free Tier Limits on Render:**

* Web service sleeps after 15 min inactivity (use Uptime Robot to ping every 5 min)
* 750 hours/month free (enough for 24/7 if single service)
* 512MB RAM, shared CPU

**Alternative Free Hostings:**

* **Railway.app** â€” $5 free credit/month, better for workers
* **Fly.io** â€” 3 free VMs, 256MB RAM each
* **Koyeb** â€” 2 free instances

---

## 11. Rate Limits & Free Tier Boundaries

| Service           | Free Limit                        | Our Usage           | Buffer                   |
| ----------------- | --------------------------------- | ------------------- | ------------------------ |
| Google Places API | ~$200 credit/mo (~2,800 searches) | ~100/day = 3,000/mo | Tight â€” use field masks |
| Groq API          | 14,400 req/day, 500K tokens/day   | ~50 req/day         | Massive buffer           |
| Brevo Email       | 300 emails/day                    | 50-100/day          | Comfortable              |
| Supabase DB       | 500MB, 2GB bandwidth              | ~50MB/month         | Large buffer             |
| Upstash Redis     | 10,000 commands/day               | ~1,000/day          | Large buffer             |
| CallMeBot         | Soft limit ~100 msg/day           | ~10-20/day          | Fine                     |
| Telegram Bot      | 30 msg/sec, unlimited total       | ~20-30/day          | Fine                     |
| Render Free       | 750 hrs/month (1 service)         | 720 hrs/month       | Tight                    |

**Cost Optimization Tips:**

* Always use Google Places `fields` mask â€” only request fields you need (reduces cost per request)
* Cache Place results in Redis for 24h to avoid re-fetching same locations
* Use Groq's fastest/smallest model (`llama-3.1-8b-instant`) unless quality suffers
* Batch Celery tasks to minimize Redis commands

---

## 12. Implementation Roadmap

### Phase 1 â€” Foundation (Week 1-2)

* [ ] Project setup: FastAPI, SQLAlchemy, Alembic, Docker
* [ ] Database: Supabase connection + all migrations
* [ ] Redis: Upstash setup + Celery config
* [ ] Google Places API: basic search + deduplication
* [ ] Seed first target locations (start with 2-3 cities)

### Phase 2 â€” Core Engine (Week 3-4)

* [ ] Lead qualification: website checker + scorer
* [ ] Email extraction: scraper + common patterns
* [ ] Groq AI integration: prompt + JSON parsing
* [ ] PDF generation: ReportLab proposal template
* [ ] Brevo SMTP: email sending with retry logic

### Phase 3 â€” Tracking & Alerts (Week 5-6)

* [ ] Tracking pixel endpoint + event logging
* [ ] Click redirect endpoint + event logging
* [ ] IMAP reply polling (every 30 min)
* [ ] Telegram bot: all alert types
* [ ] WhatsApp CallMeBot integration

### Phase 4 â€” Reporting & Orchestration (Week 7)

* [ ] openpyxl Excel report builder
* [ ] Daily summary email with attachment
* [ ] APScheduler full pipeline cron
* [ ] Master pipeline task + error handling

### Phase 5 â€” Production & Hardening (Week 8)

* [ ] Deploy to Render.com
* [ ] Uptime Robot monitoring
* [ ] GitHub Actions CI/CD pipeline
* [ ] Full end-to-end test run
* [ ] Error alerting to Telegram on pipeline failures
* [ ] Loguru structured logging

---

## 13. Security Checklist

* [ ] **API Key Auth** on all management endpoints (`X-API-Key` header)
* [ ] **Brevo webhook validation** using shared secret header
* [ ] **No PII in tracking tokens** â€” tokens are internal IDs only
* [ ] **Rate limiting** on tracking endpoints (prevent pixel spam) using slowapi
* [ ] **Environment secrets** never in code â€” all in `.env` / Render env vars
* [ ] **HTTPS only** â€” Render provides free TLS
* [ ] **SQL injection protection** â€” SQLAlchemy parameterized queries only
* [ ] **Email validation** before storing any email address
* [ ] **WHOIS/DNS check** before making HTTP requests (prevent SSRF)
* [ ] **Unsubscribe header** in all outreach emails (`List-Unsubscribe`)
* [ ] **CAN-SPAM compliance** : Real address in footer, unsubscribe link
* [ ] **Rotate Google API key** if usage spikes unexpectedly
* [ ] **DB connection pooling** â€” max 10 connections (Supabase free limit)

---

## Requirements

```txt
# requirements.txt

# Core
fastapi==0.115.0
uvicorn[standard]==0.32.0
pydantic==2.9.0
pydantic-settings==2.6.0

# Database
sqlalchemy[asyncio]==2.0.36
asyncpg==0.30.0
alembic==1.13.3

# Task Queue
celery[redis]==5.4.0
redis==5.2.0

# Scheduler
apscheduler==3.10.4

# HTTP & Scraping
httpx==0.27.2
beautifulsoup4==4.12.3
playwright==1.48.0
python-whois==0.9.4
dnspython==2.7.0

# AI
groq==0.11.0

# Email
aiosmtplib==3.0.1
jinja2==3.1.4

# PDF
reportlab==4.2.5
weasyprint==62.3

# Excel / Reports
openpyxl==3.1.5
matplotlib==3.9.2

# Notifications
python-telegram-bot==21.6

# Utilities
loguru==0.7.2
python-dotenv==1.0.1
slowapi==0.1.9
tenacity==9.0.0       # Retry logic
python-multipart==0.0.12
```

---

## Quick Start Checklist

```
â–¡ Create Supabase project â†’ get DATABASE_URL
â–¡ Create Upstash Redis â†’ get REDIS_URL
â–¡ Enable Google Places API â†’ get API key ($200 free credit)
â–¡ Create Groq account â†’ get API key (free)
â–¡ Create Brevo account â†’ get SMTP credentials (300/day free)
â–¡ Create Telegram Bot via @BotFather â†’ get TOKEN + CHAT_ID
â–¡ Register CallMeBot for WhatsApp â†’ get API key
â–¡ Clone repo â†’ cp .env.example .env â†’ fill all values
â–¡ docker-compose up -d
â–¡ alembic upgrade head
â–¡ python scripts/seed_targets.py
â–¡ Test run: python scripts/manual_trigger.py --dry-run
â–¡ Deploy to Render.com
â–¡ Configure Uptime Robot to ping /api/v1/health every 5 min
â–¡ Verify first daily report email arrives at 11:30 PM
```

---

*Architecture designed for 100% free development and production operation.*

*All services used have generous free tiers sufficient for a working lead generation operation at scale.*

*Review rate limits in Section 11 periodically as your volume grows.*
